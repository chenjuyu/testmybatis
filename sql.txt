
CREATE TABLE [dbo].[jdGoods](
	[GoodsID] [varchar](20) NOT NULL,
	[Code] [varchar](50) NULL,
	[Name] [varchar](60) NOT NULL,
	[barcodes] [varchar](200) NULL,
	[GoodsNo] [varchar](100) not NULL,
	[deptNo] [varchar](50) NULL,
	[goodsName] [varchar](500) NULL,
	[safeDays] [int] NULL,
	[thirdCategoryNo] [varchar](20) NULL,
PRIMARY KEY CLUSTERED 
(
	[GoodsNo] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY]

GO

SET ANSI_PADDING OFF
GO
GO
CREATE TABLE [dbo].[jdStock](
	[StockID] [varchar](20) COLLATE Chinese_PRC_CI_AS NOT NULL,
	[Type] [varchar](12) COLLATE Chinese_PRC_CI_AS NULL,
	[No] [varchar](20) COLLATE Chinese_PRC_CI_AS NULL,
	[Date] [datetime] NULL,
	[WarehouseID] [varchar](20) COLLATE Chinese_PRC_CI_AS NULL,
	[jddeptNo] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
	[poOrderNo] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
	[eclpSoNo] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
	[eclpRtsNo] [varchar](50) COLLATE Chinese_PRC_CI_AS NULL,
	[GoodsNo] [varchar](4000) COLLATE Chinese_PRC_CI_AS NULL,
 CONSTRAINT [PK__jdStock__18522615] PRIMARY KEY CLUSTERED 
(
	[StockID] ASC
)WITH (IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
go  
--价钱取货品资料的零售价就可以 不用改触发器了
alter table stockdetail add RelationUnitPrice money,RelationAmount money
go
Create  PROCEDURE [dbo].[ExecUpdateTablePrice] @TableTag int,@IDValue varchar(40)
--With Encryption
AS
--修改日期 2010-07-25
Declare @TableName Varchar(40),@SizeCount Int, @I int, @BoxFlag bit, @QtyField Varchar(50), @ExecStr Varchar(2000), @DiscountFlag bit, 
	@KeyField Varchar(50), @OrderNo Varchar(20), @KeyFields Varchar(100) ,@KeyField2 Varchar(50), @ParentField Varchar(50)
	Set NOCOUNT ON
	
    Select @KeyField=(Select FieldName From DataDictionary Where TableTag=@TableTag)
    Select @TableName=(Select TableName From DataDictionary Where TableTag=@TableTag)
  
   if @TableTag=25
    Update a set a.RelationUnitPrice=b.RelationUnitPrice*b.DiscountRate/10 
     from  stockdetail a,StockDetailTemp b where a.StockID=b.StockID and b.StockID=@IDValue
     and a.GoodsID=b.GoodsID and a.ColorID=b.ColorID and ISNULL(b.DiscountRate,0)>0 and ISNULL(b.DiscountRate,0)<=10    
     and ISNULL(b.RelationUnitPrice,0)<>0

     Update a set a.RelationUnitPrice=b.RelationUnitPrice
     from  stockdetail a,StockDetailTemp b where a.StockID=b.StockID and b.StockID=@IDValue
     and a.GoodsID=b.GoodsID and a.ColorID=b.ColorID and (ISNULL(b.DiscountRate,0)=0 or ISNULL(b.DiscountRate,'')='')    
     and ISNULL(b.RelationUnitPrice,0)<>0

     Update stockdetail set RelationAmount=RelationUnitPrice*Quantity where StockID=@IDValue and isnull(RelationUnitPrice,0)<>0

	Set NOCOUNT OFF
go
ALTER TRIGGER [Stock_IU] ON [dbo].[Stock] 
FOR INSERT, UPDATE Not For Replication
AS
	--if Not Update(AuditFlag)
		--Return
	--if Exists(Select Top 1 * From Deleted) and Exists(Select Top 1 * From Deleted Where AuditFlag=0) and Exists(Select * From Inserted Where AuditFlag=1)
	--	or Not Exists(Select AuditFlag From Deleted) and Exists(Select * From Inserted Where AuditFlag=1)
	update a set a.CostWarehouseID = d.CostWarehouseID from Stock a, Inserted b, Department d 
		where a.StockID=b.StockID and a.WarehouseID=d.DepartmentID 
		and (a.CostWarehouseID is null or a.CostWarehouseID <> d.CostWarehouseID)
    declare @id varchar(40)
    select @id=stockID from Inserted 
	if Exists(Select a.* From Triggers a,  Inserted b Where TableTag=25 and IDValue=b.StockID)
	begin
		Begin Tran T1
		Truncate Table StockDetailTemp_I 
		Delete a From StockDetail a,Deleted b Where a.StockID=b.StockID
		--Insert into StockDetailTemp_I(StockID,GoodsID,ColorID) Select Distinct a.StockID,GoodsID,ColorID from StockDetailTemp a,Inserted b Where a.StockID=b.StockID
		Insert into StockDetailTemp_I Select a.* from StockDetailTemp a,Inserted b Where a.StockID=b.StockID
		Exec ExecUpdateTable 25 
        Exec [ExecUpdateTablePrice] 25,@id
		Delete a From Triggers a,  Inserted b Where TableTag=25 and IDValue=b.StockID
		Commit Tran T1
	end